name: Redis Implementation Tests

on:
  push:
    branches: [ main, master, develop ]
  pull_request:
    branches: [ main, master, develop ]
  workflow_dispatch:

jobs:
  test:
    name: Run Tests
    runs-on: windows-latest
    
    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4
      
    - name: ğŸ”§ Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: '9.0.x'
        
    - name: ğŸ“¦ Setup Redis CLI
      run: |
        Write-Host "Downloading Redis for Windows..."
        $redisUrl = "https://github.com/redis-windows/redis-windows/releases/download/7.4.1/Redis-7.4.1-Windows-x64-msys2.zip"
        $redisZip = "$env:TEMP\redis.zip"
        $redisDir = "C:\redis"
        
        # Download Redis
        Invoke-WebRequest -Uri $redisUrl -OutFile $redisZip
        
        # Extract
        Write-Host "Extracting Redis..."
        Expand-Archive -Path $redisZip -DestinationPath $redisDir -Force
        
        # Find redis-cli.exe
        $redisCli = Get-ChildItem -Path $redisDir -Recurse -Filter "redis-cli.exe" | Select-Object -First 1
        
        if ($redisCli) {
          $redisPath = $redisCli.Directory.FullName
          Write-Host "Found redis-cli at: $redisPath"
          
          # Add to PATH
          echo "$redisPath" | Out-File -FilePath $env:GITHUB_PATH -Encoding utf8 -Append
          $env:PATH = "$redisPath;$env:PATH"
          
          # Verify
          & "$redisPath\redis-cli.exe" --version
        } else {
          Write-Error "redis-cli.exe not found after extraction!"
          exit 1
        }
      shell: pwsh
      
    - name: ğŸ”¨ Restore dependencies
      run: dotnet restore
      
    - name: ğŸ—ï¸ Build project
      run: dotnet build --configuration Release --no-restore
      
    - name: ğŸ§ª Run tests
      run: |
        # Ensure redis-cli is in PATH for this step
        $redisDir = "C:\redis"
        $redisCli = Get-ChildItem -Path $redisDir -Recurse -Filter "redis-cli.exe" -ErrorAction SilentlyContinue | Select-Object -First 1
        
        if ($redisCli) {
          $redisPath = $redisCli.Directory.FullName
          $env:PATH = "$redisPath;$env:PATH"
          Write-Host "Added Redis to PATH: $redisPath"
        }
        
        Write-Host "Running test suite..."
        .\run-tests.ps1 -Verbose -ContinueOnFailure
      shell: pwsh
      
    - name: ğŸ“Š Test Summary
      if: always()
      run: |
        Write-Host ""
        Write-Host "Test execution completed. Check logs above for details."
      shell: pwsh

  test-linux:
    name: Run Tests (Linux)
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4
      
    - name: ğŸ”§ Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: '9.0.x'
        
    - name: ğŸ“¦ Setup Redis
      run: |
        sudo apt-get update
        sudo apt-get install -y redis-tools redis-server
        redis-cli --version
        
    - name: ğŸ”¨ Restore dependencies
      run: dotnet restore
      
    - name: ğŸ—ï¸ Build project
      run: dotnet build --configuration Release --no-restore
      
    - name: ğŸ§ª Run basic connectivity test
      run: |
        echo "Starting Redis server..."
        dotnet run --configuration Release -- --port 6379 &
        SERVER_PID=$!
        
        sleep 2
        
        echo "Testing PING command..."
        redis-cli -p 6379 PING || echo "PING test failed"
        
        echo "Testing ECHO command..."
        redis-cli -p 6379 ECHO "Hello" || echo "ECHO test failed"
        
        echo "Stopping server..."
        kill $SERVER_PID || true
      shell: bash
